FROM golang:1.25-alpine AS build

RUN go install github.com/go-delve/delve/cmd/dlv@latest

WORKDIR /app

COPY pkg/go.mod pkg/go.sum ./pkg/
COPY services/hub_submitter_service/go.mod services/hub_submitter_service/go.sum ./src/service/

WORKDIR /app/src/service

RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    go mod download

WORKDIR /app

COPY pkg/ ./pkg/
COPY services/hub_submitter_service/ ./src/service

WORKDIR /app/src/service/cmd/

RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    go build -gcflags="all=-N -l" -o /opt/service/app .

RUN mv ../migrations /opt/service/migrations

WORKDIR /opt/service

EXPOSE 40000
EXPOSE 8056
CMD ["dlv", "exec", "./app", "--headless", "--listen=:40000", "--api-version=2", "--accept-multiclient"]

